here=$(pwd)

# Parse $SLURM_NODELIST into an iterable list of node names
NODES=`echo $SLURM_NODELIST | tr -d c | tr -d [ | tr -d ] | perl -pe 's/(\d+)-(\d+)/join(",",$1..$2)/eg' | awk 'BEGIN { RS=","} { print "c"$1 }'`
# For each item in the nodefile, connect via ssh and run the cmd.
# The -n parameter is important or ssh will consume the rest
# of the loop list in stdin.ex
# Increment rank passed to the code for each node
# Ports range

rank=${#NODES[@]}
base_port=8000

for curNode in $(echo $NODES | tr ' ' '\n' | tac); do
  file="tmp$rank"
  port=$(($base_port + $rank))
  ssh -n $curNode "export here=$here; export SLURM_NODELIST=$SLURM_NODELIST; fuser -k $port/tcp; cd $here; pwd; echo $file ; echo $port; export base_port=$base_port; echo $rank ;  python3 cnnhw.py $rank >& $file & "
  (( rank-- ))
done
